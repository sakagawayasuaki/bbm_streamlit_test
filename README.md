# 音声住所抽出アプリ

Azure Speech Servicesを使用した音声による住所抽出Streamlitアプリケーションです。2つのモードで住所入力が可能です。

## 機能

### 📋 段階入力モード
- 🔢 **3段階入力**: 郵便番号→詳細住所→建物・部屋の段階的音声入力
- 🎤 **音声録音**: 各段階でマイクから音声を録音
- 🗣️ **STT（Speech-to-Text）**: Azure Speech Servicesで音声をテキストに変換
- 📍 **郵便番号API連携**: 郵便番号から基本住所を自動取得
- 🏠 **詳細住所抽出**: 丁目以下の詳細住所を音声から抽出
- 🔊 **TTS（Text-to-Speech）**: 各段階でAIが音声確認・復唱
- ✅ **確認フロー**: OK/やり直しボタンによる入力確認

### ⚡ 高速モード
- 🎯 **一度の入力**: 完全な住所を一度に音声入力
- 🤖 **自動住所抽出**: 日本語住所パーサーで住所を自動認識
- 📊 **信頼度表示**: 複数の住所候補から最適なものを信頼度付きで表示
- 🔄 **モード切り替え**: タブで簡単にモード切り替え可能

## セットアップ

### 1. 依存関係のインストール

```bash
pip install -r requirements.txt
```

### 2. Azure Speech Services の設定

1. [Azure Portal](https://portal.azure.com/)でSpeech Servicesリソースを作成
2. APIキーとリージョンを取得
3. `.env`ファイルを作成（`.env.example`を参考に）

```bash
cp .env.example .env
```

`.env`ファイルを編集:
```env
AZURE_SPEECH_KEY=your_azure_speech_service_key_here
AZURE_SPEECH_REGION=your_azure_region_here
```

### 3. アプリケーションの起動

```bash
streamlit run app.py
```

## 使用方法

### 📋 段階入力モード

#### ステップ1: 郵便番号入力
1. **録音時間を設定** (3-15秒)
2. **「郵便番号録音開始」ボタンをクリック**
3. **郵便番号を明確に話す** (例：「123-4567」)
4. **「STT実行」ボタンで音声認識**
5. **「郵便番号を確認」ボタンで音声確認**
6. **OK/やり直しを選択**

#### ステップ2: 詳細住所入力
1. **表示された基本住所を確認**
2. **録音時間を設定** (3-30秒)
3. **「詳細住所録音開始」ボタンをクリック**
4. **丁目以下の住所を話す** (例：「1丁目2番3号」)
5. **「STT実行」ボタンで詳細住所抽出**
6. **「建物・部屋入力へ」ボタンで次のステップへ**

#### ステップ3: 建物・部屋入力
1. **現在の住所を確認**
2. **録音時間を設定** (3-30秒)
3. **「建物・部屋録音開始」ボタンをクリック**
4. **建物名・部屋番号を話す** (例：「ABCマンション405号室」)
5. **「STT実行」ボタンで建物情報認識**
6. **「完了」ボタンまたは「スキップ」で次へ**

#### ステップ4: 確認・完了
1. **抽出された完全な住所を確認**
2. **「完全住所を復唱」ボタンで音声確認**
3. **必要に応じて「最初からやり直し」**

### ⚡ 高速モード

1. **録音時間を設定** (5-60秒)
2. **「住所録音開始」ボタンをクリック**
3. **完全な住所を一度に話す** (例：「東京都渋谷区神宮前1丁目2番3号 ABCマンション405号室」)
4. **「住所解析実行」ボタンで自動抽出**
5. **抽出された住所候補を確認**
6. **最適住所の結果を確認**

## ファイル構成

```
.
├── app.py                    # メインのStreamlitアプリ（タブ切り替え式）
├── speech_service.py         # Azure Speech Services統合
├── address_extractor.py      # 住所抽出ロジック（詳細住所用）
├── postal_code_service.py    # 郵便番号API連携・抽出
├── japanese_address_parser.py # 日本語住所パーサー（高速モード用）
├── realtime_speech_service.py # Google Cloud STT（未使用）
├── requirements.txt          # 依存関係
├── .env.example             # 環境変数テンプレート
└── README.md                # このファイル
```

## 技術仕様

- **言語**: Python 3.8+
- **フレームワーク**: Streamlit
- **音声処理**: Azure Cognitive Services Speech SDK
- **音声録音**: sounddevice
- **郵便番号API**: zipcloud API（無料）
- **住所抽出**: 
  - 段階入力モード: 正規表現ベース（詳細住所用）
  - 高速モード: 包括的日本語住所パーサー（信頼度計算付き）
- **UI状態管理**: Streamlitセッション状態による段階フロー制御
- **モード切り替え**: Streamlitタブによる段階入力・高速モード切り替え

## 注意事項

- Azure Speech Servicesの使用には課金が発生する場合があります
- マイクへのアクセス許可が必要です
- インターネット接続が必要です（Azure APIへのアクセス）
- 住所の認識精度は音声の明瞭さに依存します

## トラブルシューティング

### 郵便番号が認識されない場合
- 郵便番号を一つずつゆっくり話す（例：「1・2・3・ハイフン・4・5・6・7」）
- ハイフンを「の」と発音する（例：「123の4567」）
- 録音時間を短めに設定して雑音を減らす

### 音声が認識されない場合
- マイクの音量を確認
- 静かな環境で録音する
- 録音時間を適切に設定

### Azure接続エラーの場合
- `.env`ファイルの設定を確認
- Azure Speech Servicesリソースが有効か確認
- インターネット接続を確認

### 住所API検索エラーの場合
- 郵便番号の形式を確認（7桁の数字）
- インターネット接続を確認
- 存在しない郵便番号でないか確認

### 詳細住所が抽出されない場合
- 「1丁目2番3号」のような明確な形式で話す
- 数字を含む部分を明確に発音
- 「の」で区切って話す（例：「1丁目の2の3」）